<% # TODO mover para helper
base_path        = Rails.root.join('app', 'assets', 'javascripts', 'models')
models_list      = Dir.glob(Rails.root.join(base_path, '**', '*.js*'))
models_list.map! do |file|
   file.sub! base_path.to_s + '/', ''

   # Ignore Emacs temporary files
   next nil if file =~ /~/

   entries         = file.split /\// || []
   entries.unshift 'models'
   entries.push    File.basename entries.pop, '.js.coffee'
   File.join *entries

end.compact!

models_list.each do |model_file|
  require_asset model_file
end

%>

'use strict'


root = exports ? this

define 'aura/extensions/models', <%= models_list.to_json  %>, (models...) ->

  # TODO better require api for indemma
  indemma = require 'indemma'
  require 'indefinido-indemma/lib/extensions/rivets'
  require 'indefinido-indemma/lib/record/rest'
  require 'indefinido-indemma/lib/record/associable'
  require 'indefinido-indemma/lib/record/storable'
  require 'indefinido-indemma/lib/record/persistable'
  require 'indefinido-indemma/lib/record/queryable'
  require 'indefinido-indemma/lib/record/scopable'
  require 'indefinido-indemma/lib/record/restfulable'
  require 'indefinido-indemma/lib/record/resource'
  require 'indefinido-indemma/lib/record/maid'
  require 'indefinido-indemma/lib/record/validatable'

  # TODO create an plurazation interface on indemma, or move
  # inflector outside it
  require 'indefinido-indemma/vendor/owl/pluralize'

  # Extension definition
  initialize: (application) ->
    core                = application.core
    sandbox             = application.sandbox
    core.util.inflector =
      cssify: (sentence) ->  sentence.replace /\//, '-'
      pluralize: indemma.model.pluralize
      singularize: indemma.model.singularize
      # TODO create an plurazation interface on indemma, or move
      # inflector outside it
      define: owl.pluralize.define

    # TODO rename core.models and core.domain to core.resources, completely
    core.resourceable = core.resources = core.domain = core.models   = sandbox.models = indemma.model

    core.resource = core.model  = sandbox.resource = sandbox.model = (name) ->
      # TODO use a Map internally in indemma
      model = indemma.model[name]
      throw new TypeError unless model?
      model

    # TODO rename core.models and core.domain, to core.resources, completely
    # TODO deprecate record usage
    core.domain.record = core.models.record = sandbox.models.record = indemma.record

    # TODO allow user to create custom definitions before resources
    # (models) get defined
    core.util.inflector.define 'measures', 'measures'

    # Build all model definitions
    core.util._.map models, (model) -> indemma.model.call model
